name: Deploy

on:
  workflow_call:

permissions:
  id-token: write
  contents: read

env:
  PROJECT_ID: syufy-485423
  REGION: asia-northeast1
  SERVICE_NAME: mini-hackathon
  REPO_NAME: syufy
  INSTANCE_CONN: syufy-485423:asia-northeast1:mini-hackathon-db

jobs:
  terraform:
    name: Terraform Apply
    uses: ./.github/workflows/terraform-apply.yml
    secrets: inherit

  deploy:
    name: Deploy to Cloud Run
    needs: terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # GCP 認証 (Workload Identity Federation)
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - uses: google-github-actions/setup-gcloud@v2

      # Artifact Registry への Docker 認証
      - run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # イメージタグ決定
      - name: Determine image tag
        id: tag
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}"
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="sha-${GITHUB_SHA::7}"
          fi
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      # Docker build
      - name: Build Docker image
        run: |
          docker build --platform linux/amd64 \
            --build-arg NEXT_PUBLIC_FIREBASE_API_KEY="${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN="${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_PROJECT_ID="${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET="${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID="${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_APP_ID="${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}" \
            -t "${{ steps.tag.outputs.image }}:${{ steps.tag.outputs.tag }}" \
            -t "${{ steps.tag.outputs.image }}:latest" \
            .

      # Docker push
      - name: Push Docker image
        run: |
          docker push "${{ steps.tag.outputs.image }}:${{ steps.tag.outputs.tag }}"
          docker push "${{ steps.tag.outputs.image }}:latest"

      # DB マイグレーション (Cloud SQL Auth Proxy 経由)
      - name: Download Cloud SQL Auth Proxy
        run: |
          curl -sSL -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.14.3/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy

      - name: Run database migration
        env:
          DATABASE_URL: postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@127.0.0.1:5433/${{ secrets.DB_NAME }}
        run: |
          ./cloud-sql-proxy "${{ env.INSTANCE_CONN }}" --port 5433 &
          PROXY_PID=$!
          sleep 3

          npm ci
          npx prisma generate
          npx prisma migrate deploy

          kill $PROXY_PID || true

      # Cloud Run デプロイ
      - name: Deploy to Cloud Run
        env:
          DB_URL: postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@localhost/${{ secrets.DB_NAME }}?host=/cloudsql/${{ env.INSTANCE_CONN }}
        run: |
          gcloud run deploy "${{ env.SERVICE_NAME }}" \
            --image "${{ steps.tag.outputs.image }}:latest" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 3 \
            --add-cloudsql-instances "${{ env.INSTANCE_CONN }}" \
            --service-account "cloudrun-mini-hackathon@${{ env.PROJECT_ID }}.iam.gserviceaccount.com" \
            --set-env-vars "NODE_ENV=production,\
          DATABASE_URL=${DB_URL},\
          FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }},\
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }},\
          NOTIFY_SECRET=${{ secrets.NOTIFY_SECRET }},\
          GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME }},\
          IMAGE_BASE_URL=${{ secrets.IMAGE_BASE_URL }},\
          NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }},\
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }},\
          NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }},\
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }},\
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }},\
          NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}" \
            --set-env-vars "^##^FIREBASE_PRIVATE_KEY=${{ secrets.FIREBASE_PRIVATE_KEY }}"

      - name: Show deploy URL
        run: |
          gcloud run services describe "${{ env.SERVICE_NAME }}" \
            --region "${{ env.REGION }}" \
            --format='value(status.url)'
