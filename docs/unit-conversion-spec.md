# 単位正規化・換算ルール仕様書

## 1. 概要

本仕様書は、在庫（Inventory）とレシピ材料（RecipeIngredient）の数量比較を可能にするための、単位の正規化ルールと換算ロジックを定義する。

## 2. 対応する単位一覧

### 2.1 単位カテゴリ

| カテゴリID | カテゴリ名 | 基準単位 | 対象単位 |
|-----------|-----------|----------|----------|
| MASS | 重量 | g | g, kg, mg |
| VOLUME | 容量 | ml | ml, L, cc |
| SPOON | 計量スプーン | ml | 大さじ, 小さじ, カップ |
| COUNT | 個数 | 個 | 個, 本, 枚, 束, パック, 玉, 株, 房, 切れ, 片 |
| IMPRECISE | 曖昧表現 | - | 少々, ひとつまみ, 適量, お好みで |
| UNKNOWN | 不明 | - | 上記以外 |

### 2.2 単位の詳細

#### 重量系 (MASS)
- `g` - グラム（基準単位）
- `kg` - キログラム (1kg = 1000g)
- `mg` - ミリグラム (1mg = 0.001g)

#### 容量系 (VOLUME)
- `ml` - ミリリットル（基準単位）
- `L` - リットル (1L = 1000ml)
- `cc` - シーシー (1cc = 1ml)

#### 計量スプーン系 (SPOON)
- `小さじ` - 5ml
- `大さじ` - 15ml
- `カップ` - 200ml（日本の計量カップ基準）

#### 個数系 (COUNT)
- `個` - 一般的な個数（基準単位）
- `本` - 細長いもの（にんじん、ねぎ等）
- `枚` - 薄いもの（肉、葉物等）
- `束` - 束ねたもの（ほうれん草等）
- `パック` - パック入り商品
- `玉` - 丸いもの（玉ねぎ等）
- `株` - 根菜類（白菜等）
- `房` - 房状のもの（バナナ、ぶどう等）
- `切れ` - 切り分けたもの（魚等）
- `片` - にんにく等

#### 曖昧表現 (IMPRECISE)
- `少々` - 指2本でつまむ程度（約0.5g）
- `ひとつまみ` - 指3本でつまむ程度（約1g）
- `適量` - 定量化不可
- `お好みで` - 定量化不可

## 3. 正規化マッピング（表記ゆれ対応）

### 3.1 重量系

| 入力パターン | 正規化後 |
|-------------|---------|
| グラム, ｇ, G | g |
| キロ, キログラム, ㎏ | kg |
| ミリグラム | mg |

### 3.2 容量系

| 入力パターン | 正規化後 |
|-------------|---------|
| ミリリットル, ｍｌ, ML | ml |
| リットル, Ｌ | L |
| シーシー, ｃｃ, CC | cc |

### 3.3 計量スプーン系

| 入力パターン | 正規化後 |
|-------------|---------|
| 大匙, 大サジ, tbsp, Tbsp | 大さじ |
| 小匙, 小サジ, tsp, Tsp | 小さじ |
| cup, Cup | カップ |

### 3.4 個数系

| 入力パターン | 正規化後 |
|-------------|---------|
| こ, コ, ケ | 個 |
| ぽん, ホン | 本 |
| まい, マイ | 枚 |
| たば, タバ | 束 |
| ぱっく, パツク | パック |
| たま, タマ | 玉 |
| かぶ, カブ | 株 |
| ふさ, フサ | 房 |
| きれ, キレ | 切れ |

### 3.5 曖昧表現

| 入力パターン | 正規化後 |
|-------------|---------|
| しょうしょう, ショウショウ | 少々 |
| 一つまみ, 1つまみ | ひとつまみ |
| てきりょう, テキリョウ | 適量 |

## 4. 分数表現のパースルール

### 4.1 対応する形式

| 入力例 | パース結果 |
|--------|-----------|
| 1/2本 | value: 0.5, unit: 本 |
| 1/4個 | value: 0.25, unit: 個 |
| 3/4カップ | value: 0.75, unit: カップ |
| 半分 | value: 0.5, unit: (なし) |
| 半個 | value: 0.5, unit: 個 |
| 1.5本 | value: 1.5, unit: 本 |
| 2個半 | value: 2.5, unit: 個 |

### 4.2 パースロジック

1. 分数パターン `n/m` を検出し、小数に変換
2. 「半」「半分」を0.5として処理
3. 単位部分を分離して正規化

## 5. 換算テーブル

### 5.1 計量スプーン → ml

| 単位 | ml換算値 |
|------|----------|
| 小さじ | 5 |
| 大さじ | 15 |
| カップ | 200 |

### 5.2 重量換算

| 換算元 | 換算先 | 係数 |
|--------|--------|------|
| kg | g | 1000 |
| mg | g | 0.001 |
| g | kg | 0.001 |
| g | mg | 1000 |

### 5.3 容量換算

| 換算元 | 換算先 | 係数 |
|--------|--------|------|
| L | ml | 1000 |
| cc | ml | 1 |
| ml | L | 0.001 |

## 6. 食材密度テーブル（重量⇔容量変換用）

### 6.1 調味料

| 食材名 | 密度(g/ml) | 大さじ1(g) | 小さじ1(g) | 備考 |
|--------|-----------|-----------|-----------|------|
| 水 | 1.0 | 15 | 5 | 基準 |
| 醤油 | 1.15 | 18 | 6 | |
| みりん | 1.13 | 17 | 6 | |
| 酒 | 1.0 | 15 | 5 | |
| 酢 | 1.0 | 15 | 5 | |
| 味噌 | 1.1 | 18 | 6 | |
| 砂糖（上白糖） | 0.6 | 9 | 3 | |
| 塩 | 1.2 | 18 | 6 | |
| 油・オリーブオイル | 0.9 | 14 | 4 | |
| はちみつ | 1.4 | 21 | 7 | |
| マヨネーズ | 0.9 | 14 | 4 | |
| ケチャップ | 1.15 | 17 | 6 | |
| ソース | 1.2 | 18 | 6 | |
| 牛乳 | 1.03 | 15 | 5 | |
| 生クリーム | 1.0 | 15 | 5 | |

### 6.2 粉類

| 食材名 | 密度(g/ml) | 大さじ1(g) | 小さじ1(g) |
|--------|-----------|-----------|-----------|
| 小麦粉 | 0.55 | 8 | 3 |
| 片栗粉 | 0.65 | 10 | 3 |
| パン粉 | 0.25 | 4 | 1 |
| ベーキングパウダー | 0.8 | 12 | 4 |

## 7. 比較ロジック

### 7.1 フローチャート

```
1. 在庫とレシピ材料の単位を正規化
   ↓
2. 単位カテゴリを判定
   ↓
3. 同一カテゴリか?
   ├─ YES → 基準単位に変換して数値比較
   └─ NO → カテゴリ間変換を試行
         ├─ MASS ↔ VOLUME: 密度テーブルで変換
         ├─ SPOON → VOLUME: 換算定数で変換
         ├─ SPOON → MASS: 密度テーブル + 換算定数
         └─ その他: 比較不可
   ↓
4. 比較結果を返す
   - canCompare: true/false
   - isEnough: true/false
   - shortage: 不足量
```

### 7.2 比較可能なケース

| 在庫単位 | レシピ単位 | 比較方法 |
|---------|-----------|---------|
| g | g | 直接比較 |
| g | kg | 在庫をkgに変換して比較 |
| ml | ml | 直接比較 |
| ml | L | 在庫をLに変換して比較 |
| g | 大さじ | レシピを密度でgに変換して比較 |
| ml | 大さじ | レシピを15ml×数量に変換して比較 |
| 大さじ | 小さじ | 両方をmlに変換して比較 |

### 7.3 比較不可能なケース

| 在庫単位 | レシピ単位 | 理由 |
|---------|-----------|------|
| 本 | g | 個体差が大きく換算不可 |
| 個 | ml | カテゴリが異なり密度情報なし |
| 適量 | - | 定量化不可 |
| なし | あり | 単位情報不足 |

### 7.4 曖昧表現の扱い

- 在庫が曖昧表現の場合: **在庫あり**とみなす（比較不可だが存在は認識）
- レシピが曖昧表現の場合: **不問**（必要量が定まらないため）

## 8. 例外処理

### 8.1 エラーケース

1. **単位が空文字または未定義**: `UNKNOWN`カテゴリとして処理
2. **数値が0または負**: 有効な数量として扱わない
3. **密度テーブルに食材がない**: カテゴリ間変換不可として処理

### 8.2 ログ出力

換算失敗時は以下の情報をログに記録:
- 元の単位と数量
- 変換先の単位
- 失敗理由

## 9. 今後の拡張ポイント

1. **食材名の正規化**: 「玉ねぎ」「たまねぎ」「タマネギ」の統一
2. **密度テーブルの拡充**: より多くの食材に対応
3. **個数⇔重量換算**: 野菜の平均重量テーブルの追加
4. **ユーザーカスタマイズ**: 独自の換算ルール登録機能
