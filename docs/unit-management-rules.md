# 調味料・油脂類を含む在庫単位管理ルール

> Issue #75 対応。単位換算の基本仕様は [unit-conversion-spec.md](./unit-conversion-spec.md) を参照。

## 1. 調味料・油脂類の管理単位ルール

### 1.1 基本方針

在庫の管理単位は**レシート解析時のパッケージ単位**を基本とする。レシピとの比較時に必要な換算は、密度テーブル（`lib/units/constants.ts` の `INGREDIENT_DENSITIES`）を使って自動的に行う。

### 1.2 カテゴリ別の管理単位

| 食材カテゴリ | 管理単位 | 例 | 備考 |
|-------------|---------|-----|------|
| 液体調味料 | VOLUME系（ml/L） | 醤油500ml、みりん1L | パッケージに容量表記があるため |
| 固形調味料 | MASS系（g/kg） | 砂糖1kg、塩500g | パッケージに重量表記があるため |
| 油類 | VOLUME系（ml/L）又はCOUNT系 | オリーブオイル500ml、ごま油1本 | レシートの表記に従う |
| バター | MASS系（g） | バター200g | パッケージにg表記が一般的 |
| マヨネーズ・ケチャップ | MASS系（g）又はCOUNT系 | マヨネーズ400g、ケチャップ1本 | レシートの表記に従う |
| 粉類 | MASS系（g/kg） | 小麦粉1kg、片栗粉200g | パッケージに重量表記があるため |

### 1.3 レシピとの換算

レシピでは「大さじ2」「小さじ1」のような計量スプーン表記が一般的。在庫がg/ml管理の場合、以下の換算パスで比較する:

```
在庫(g) ←→ 密度テーブル ←→ ml ←→ 計量スプーン換算 ←→ レシピ(大さじN)
```

**換算可能な組み合わせ:**
- バター200g、レシピ「バター大さじ2」→ 大さじ→ml(30ml)→g(28.5g) → 200g ≥ 28.5g → 十分
- 醤油500ml、レシピ「醤油大さじ3」→ 大さじ→ml(45ml) → 500ml ≥ 45ml → 十分

**換算不可の場合（COUNT系 ↔ MASS/VOLUME）:**
- 在庫「サラダ油1本」、レシピ「油大さじ2」→ COUNT系とSPOON系は直接換算不可
- この場合、在庫に名前マッチがあれば `unknown` ステータス（在庫存在は認識するが過不足は判定不可）

### 1.4 密度テーブル対応状況

`lib/units/constants.ts` の `INGREDIENT_DENSITIES` に以下が登録済み:

| カテゴリ | 登録済み食材 |
|---------|-----------|
| 基本調味料 | 醤油、みりん、酒、酢、味噌、砂糖、塩 |
| 油脂類 | 油（サラダ油/ごま油/オリーブオイル含む）、バター（無塩/有塩/マーガリン含む） |
| その他調味料 | はちみつ、マヨネーズ、ケチャップ、ソース |
| 乳製品 | 牛乳、生クリーム、ヨーグルト |
| 粉類 | 小麦粉（薄力粉/強力粉含む）、片栗粉、パン粉、ベーキングパウダー |

---

## 2. 在庫比較の換算仕様

### 2.1 換算可否マトリクス

| 在庫＼レシピ | MASS | VOLUME | SPOON | COUNT | IMPRECISE |
|-------------|------|--------|-------|-------|-----------|
| **MASS** | 直接 | 密度※ | 密度※ | 不可 | 不問 |
| **VOLUME** | 密度※ | 直接 | 定数 | 不可 | 不問 |
| **SPOON** | 密度※ | 定数 | 定数 | 不可 | 不問 |
| **COUNT** | 不可 | 不可 | 不可 | 直接※※ | 不問 |
| **IMPRECISE** | 不問 | 不問 | 不問 | 不問 | 不問 |

- ※ 密度テーブルに登録がある食材のみ
- ※※ COUNT系同士（例: 個と本）は同一正規化値のみ直接比較。異なるCOUNT単位間の換算は不可

### 2.2 換算不可時の動作

- **在庫に名前マッチあり**: ステータス `unknown`（在庫は存在するが過不足不明）
- **在庫に名前マッチなし**: ステータス `missing`
- **レシピ側が曖昧表現**: ステータス `available`（在庫があれば十分とみなす）

---

## 3. 期限入力・表示ルール

### 3.1 デフォルト期限の自動設定

レシート解析時、Geminiが賞味期限・消費期限を返さなかった場合（通常レシートに記載がないため）、食材カテゴリに基づいてデフォルト期限を自動設定する。

実装: `lib/expiry-defaults.ts` の `getDefaultExpiryDates()`

**自動設定対象（生鮮食材のみ）:**

| カテゴリ | 対象食材例 | 賞味期限 | 消費期限 |
|---------|-----------|---------|---------|
| 魚介類 | 鮭、刺身、エビ | 購入+1日 | 購入+2日 |
| 生鮮肉類 | 鶏、豚、牛、ひき肉 | 購入+2日 | 購入+3日 |
| 葉物野菜 | レタス、ほうれん草、もやし | 購入+3日 | 購入+5日 |
| パン | 食パン、ベーグル | 購入+3日 | 購入+5日 |
| 豆腐・納豆 | 豆腐、納豆、油揚げ | 購入+5日 | 購入+7日 |
| 乳製品 | 牛乳、ヨーグルト、チーズ | 購入+7日 | 購入+10日 |
| キャベツ・白菜 | キャベツ、白菜、ブロッコリー | 購入+7日 | 購入+10日 |
| 果物 | りんご、バナナ、みかん | 購入+7日 | 購入+10日 |
| 根菜類 | じゃがいも、人参、玉ねぎ | 購入+14日 | 購入+21日 |
| 卵 | 卵 | 購入+14日 | 購入+21日 |

**自動設定しない（手動入力）:**
- 調味料・油脂類（醤油、味噌、油、バター、ソース等）
- 飲料（ビール、ジュース、お茶等）
- 缶詰・レトルト食品
- 冷凍食品
- 上記カテゴリにマッチしないもの

これらは長期保存が可能なため、プレビュー画面でユーザーが必要に応じて手動入力する。

### 3.2 ユーザーによる修正

- プレビュー画面（`ReceiptUploadPanel`）のdate入力フィールドで期限を確認・修正可能
- 自動設定された生鮮食材の期限も変更可能
- 長期保存品は空欄で表示され、ユーザーが任意で入力

### 3.3 通知タイミング

- **消費期限（consumeBy）**: 3日前・1日前・当日に通知
- **賞味期限（expireDate）**: 7日前・3日前・当日に通知
- レシピ生成時: 消費期限が近い食材を優先的に使用するようGeminiに指示

---

## 4. クイック消費の仕様

在庫一覧画面の消費ボタンは「クイック消費」として、単位カテゴリに応じた固定量を消費する。

| 単位カテゴリ | 消費量 | ボタン表示 | 例 |
|------------|--------|-----------|-----|
| COUNT系 | 1 | -1 | 卵: 10個→9個 |
| MASS系 | 100g相当 | -100g | バター: 200g→100g |
| VOLUME系 | 100ml相当 | -100ml | 醤油: 500ml→400ml |

- 残量が消費単位以下の場合 → 全量消費して在庫を削除
- 任意の数量変更 → 編集モーダル（InventoryEditModal）を使用

実装: `lib/units/comparator.ts` の `getConsumeInfo()`
