# 期限通知 テスト方針（確定版）

## 目的
開発中の段階で、期限通知の仕様が矛盾なく動作するかを最小コストで確認する。

## 仕様（確定）
- 通知対象: 消費期限（use_by）/ 賞味期限（best_before）
- 通知タイミング:
  - 消費期限: 3日前 / 前日 / 当日
  - 賞味期限: 7日前 / 3日前 / 当日
- 通知頻度: 1日1回（例: 08:00）
- 重複防止: 同じ在庫・同じタイミングで1回のみ
- 期限切れ後: 通知しない
- 在庫が0になったら通知停止
- 1日複数回通知: しない（1日1回のみ）
- 期限の粒度: 日付のみ（時刻は扱わない）
- 期限未設定の在庫: 通知対象から除外する

## 重複判定キー
- 「在庫 × 期限種別 × 期限日 × タイミング」で一意

## テストの進め方（コードなしで可能）
### 1. 仕様レビュー
- 発火条件が明確か（「何日前」「当日」の定義）
- 時刻基準が明確か（毎日 08:00 で判定）
- 重複防止のキーが明確か（例: inventory_id + expiry_kind + trigger_day）

### 2. 机上シミュレーション
- 「今日の日付」を固定して、通知が出る対象を手計算する
- 結果が直感に一致するかを確認

## テスト観点（チェックリスト）
- 期限が**当日**のとき通知される
- 期限が**3日前**（消費期限/賞味期限）で通知される
- 期限が**7日前**（賞味期限のみ）で通知される
- 期限が**未設定**の在庫は通知されない
- 在庫が**0**なら通知されない
- 期限が**過ぎた**在庫は通知されない
- 2回実行しても**重複通知が増えない**

## テスト観点（確定仕様に基づく追加）
- 通知は**1日1回のみ**である（同日複数回の生成をしない）
- 通知時刻は**固定（08:00想定）**として扱われる
- 期限は**日付のみ**で比較される（時刻差の影響を受けない）
- 在庫が**0以下**の場合は通知されない
- 消費期限と賞味期限の**両方がある場合**はそれぞれのルールで判定される
- 期限日が同じでも**消費期限/賞味期限で別通知**になる

## ケース例（今日 = 2026-01-29 とする）
| 在庫 | 種別 | 期限日 | 期待される通知 | 理由 |
| --- | --- | --- | --- | --- |
| 牛乳 | use_by | 2026-02-01 | 3日前通知（1/29） | 消費期限3日前 |
| 卵 | use_by | 2026-01-30 | 前日通知（1/29） | 消費期限前日 |
| 野菜 | best_before | 2026-02-05 | 7日前通知（1/29） | 賞味期限7日前 |
| 肉 | best_before | 2026-02-01 | 3日前通知（1/29） | 賞味期限3日前 |
| 豆腐 | use_by | 2026-01-29 | 当日通知（1/29） | 当日 |
| パン | best_before | 2026-01-29 | 当日通知（1/29） | 当日 |
| 冷凍魚 | use_by | 2026-02-10 | なし | 条件外 |
| 調味料 | best_before | なし | なし | 期限未設定 |

## 次のステップ（実装前）
- バッチ（自動実行）の実装方針を決める

## TODO（本番自動化向け）
- [ ] 期限通知の自動実行を追加する（バッチ/cron）
- [ ] 対象ユーザーを全体に拡張する（全ユーザー分の実行）
- [ ] 認証/安全対策を入れる（管理者専用 or シークレット）
- [ ] 失敗時のリトライ/監視を検討する
