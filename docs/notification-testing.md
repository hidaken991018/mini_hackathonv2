# 期限通知 テスト方針（開発中向け）

## 目的
開発中の段階で、期限通知の仕様が矛盾なく動作するかを最小コストで確認する。

## 前提（今回の仕様）
- 通知対象: 消費期限（use_by）/ 賞味期限（best_before）
- 通知タイミング:
  - 消費期限: 3日前 / 前日 / 当日
  - 賞味期限: 7日前 / 3日前 / 当日
- 通知頻度: 1日1回（例: 08:00）
- 重複防止: 同じ在庫・同じタイミングで1回のみ
- 在庫が0になったら通知停止

## テストの進め方（コードなしで可能）
### 1. 仕様レビュー
- 発火条件が明確か（「何日前」「当日」の定義）
- 時刻基準が明確か（毎日 08:00 で判定）
- 重複防止のキーが明確か（例: inventory_id + expiry_kind + trigger_day）

### 2. 机上シミュレーション
- 「今日の日付」を固定して、通知が出る対象を手計算する
- 結果が直感に一致するかを確認

## テスト観点（チェックリスト）
- 期限が**当日**のとき通知される
- 期限が**3日前**（消費期限/賞味期限）で通知される
- 期限が**7日前**（賞味期限のみ）で通知される
- 期限が**未設定**の在庫は通知されない
- 在庫が**0**なら通知されない
- 期限が**過ぎた**場合はどう扱うか（通知する/しない）
- 2回実行しても**重複通知が増えない**

## ケース例（今日 = 2026-01-29 とする）
| 在庫 | 種別 | 期限日 | 期待される通知 | 理由 |
| --- | --- | --- | --- | --- |
| 牛乳 | use_by | 2026-02-01 | 3日前通知（1/29） | 消費期限3日前 |
| 卵 | use_by | 2026-01-30 | 前日通知（1/29） | 消費期限前日 |
| 野菜 | best_before | 2026-02-05 | 7日前通知（1/29） | 賞味期限7日前 |
| 肉 | best_before | 2026-02-01 | 3日前通知（1/29） | 賞味期限3日前 |
| 豆腐 | use_by | 2026-01-29 | 当日通知（1/29） | 当日 |
| パン | best_before | 2026-01-29 | 当日通知（1/29） | 当日 |
| 冷凍魚 | use_by | 2026-02-10 | なし | 条件外 |
| 調味料 | best_before | なし | なし | 期限未設定 |

## 追加で詰めたい点（未確定なら要確認）
- 期限が過ぎた場合の扱い（通知する / しない / 別種通知）
- 通知の時刻をユーザーが変更できるか
- 1日に複数回の通知を許容するか
- 期限の定義（日付のみ or 時刻まで）

## TODO（未確定事項）
- 期限切れ後の扱いを決める（通知する / しない / 別種通知）
- 通知時刻を固定にするかユーザー設定にするか決める
- 1日複数回通知の可否を決める
- 期限の粒度を決める（日付のみ or 時刻まで）
- 重複判定のキーを決める（例: inventory_id + expiry_kind + trigger_day）
- 期限未設定の在庫を完全除外で良いか確認する

## 次のステップ（実装前）
- 本ドキュメントの内容をもとに仕様を確定
- 必要なバッチ/APIの洗い出し
- 重複防止キーの確定
