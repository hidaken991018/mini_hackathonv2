# 在庫管理機能 仕様書

## 1. 概要

在庫（食材）の基本操作（一覧表示/詳細表示/編集/消費/削除）を提供する機能。
BottomNavに「在庫」タブを追加し、4タブ構成とする。

---

## 2. データ型定義

### InventoryItemWithId

```typescript
type InventoryItemWithId = {
  id: string;              // UUID
  name: string;            // 食材名（必須）
  quantityValue?: number;  // 数量
  quantityUnit?: string;   // 単位（例: "個", "g", "ml"）
  expireDate?: string;     // 賞味期限 (YYYY-MM-DD)
  consumeBy?: string;      // 消費期限 (YYYY-MM-DD)
  note?: string;           // メモ
  imageUrl?: string;       // 画像URL
  createdAt: string;       // 作成日時 (ISO 8601)
  updatedAt: string;       // 更新日時 (ISO 8601)
};
```

---

## 3. API仕様

### 3.1 在庫一覧取得

**エンドポイント:** `GET /api/inventories`

**クエリパラメータ:**
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| userId | string | Yes | ユーザーID |

**レスポンス (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid-1",
      "name": "卵",
      "quantityValue": 6,
      "quantityUnit": "個",
      "expireDate": "2025-02-10",
      "consumeBy": null,
      "note": null,
      "imageUrl": null,
      "createdAt": "2025-01-30T10:00:00.000Z",
      "updatedAt": "2025-01-30T10:00:00.000Z"
    }
  ]
}
```

**エラーレスポンス:**
- 400: userIdが指定されていない
- 500: サーバーエラー

---

### 3.2 在庫詳細取得

**エンドポイント:** `GET /api/inventories/[id]`

**パスパラメータ:**
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string | 在庫ID (UUID) |

**レスポンス (200 OK):**
```json
{
  "success": true,
  "data": {
    "id": "uuid-1",
    "name": "卵",
    "quantityValue": 6,
    "quantityUnit": "個",
    "expireDate": "2025-02-10",
    "consumeBy": null,
    "note": null,
    "imageUrl": null,
    "createdAt": "2025-01-30T10:00:00.000Z",
    "updatedAt": "2025-01-30T10:00:00.000Z"
  }
}
```

**エラーレスポンス:**
- 404: 在庫が見つからない
- 500: サーバーエラー

---

### 3.3 在庫更新

**エンドポイント:** `PUT /api/inventories/[id]`

**パスパラメータ:**
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string | 在庫ID (UUID) |

**リクエストボディ:**
```json
{
  "name": "卵",
  "quantityValue": 5,
  "quantityUnit": "個",
  "expireDate": "2025-02-10",
  "consumeBy": null,
  "note": "冷蔵庫上段"
}
```

**レスポンス (200 OK):**
```json
{
  "success": true,
  "data": {
    "id": "uuid-1",
    "name": "卵",
    "quantityValue": 5,
    "quantityUnit": "個",
    "expireDate": "2025-02-10",
    "consumeBy": null,
    "note": "冷蔵庫上段",
    "imageUrl": null,
    "createdAt": "2025-01-30T10:00:00.000Z",
    "updatedAt": "2025-01-30T12:00:00.000Z"
  }
}
```

**エラーレスポンス:**
- 404: 在庫が見つからない
- 500: サーバーエラー

---

### 3.4 在庫削除

**エンドポイント:** `DELETE /api/inventories/[id]`

**パスパラメータ:**
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string | 在庫ID (UUID) |

**レスポンス (200 OK):**
```json
{
  "success": true
}
```

**エラーレスポンス:**
- 404: 在庫が見つからない
- 500: サーバーエラー

---

### 3.5 在庫消費（1単位減算）

**エンドポイント:** `PATCH /api/inventories/[id]/consume`

**パスパラメータ:**
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string | 在庫ID (UUID) |

**動作:**
- 数量を1減算する
- 数量が0以下になった場合、在庫を削除する

**レスポンス (200 OK) - 数量が残っている場合:**
```json
{
  "success": true,
  "data": {
    "deleted": false,
    "inventory": {
      "id": "uuid-1",
      "name": "卵",
      "quantityValue": 5,
      "quantityUnit": "個"
    }
  }
}
```

**レスポンス (200 OK) - 数量が0になった場合:**
```json
{
  "success": true,
  "data": {
    "deleted": true,
    "id": "uuid-1"
  }
}
```

**エラーレスポンス:**
- 404: 在庫が見つからない
- 500: サーバーエラー

---

## 4. UI仕様

### 4.1 画面構成

```
┌─────────────────────────────┐
│      ScreenHeader           │
│      "在庫"    [件数表示]    │
├─────────────────────────────┤
│                             │
│   ┌─────────────────────┐   │
│   │ 卵         6個  [-1]│   │
│   │ 賞味: 2025-02-10    │   │  ← 賞味期限（卵カテゴリ）
│   └─────────────────────┘   │
│   ┌─────────────────────┐   │
│   │ 鶏むね肉   1パック[-1]│  │
│   │ 消費: 2025-02-05    │   │  ← 消費期限（生鮮肉カテゴリ, 赤背景=期限切れ）
│   └─────────────────────┘   │
│   ┌─────────────────────┐   │
│   │ ほうれん草  1束 [-1]│   │
│   │ 鮮度目安: 2/14頃    │   │  ← 鮮度目安（葉物野菜カテゴリ）
│   └─────────────────────┘   │
│   ┌─────────────────────┐   │
│   │ 醤油       1本      │   │  ← 常備品（期限表示なし）
│   └─────────────────────┘   │
│                             │
├─────────────────────────────┤
│ [Input][在庫][Chat][通知]   │
│        BottomNav            │
└─────────────────────────────┘
```

### 4.2 在庫アイテム（InventoryItem）

**表示内容:**
- 食材名
- 数量 + 単位
- 期限（食材カテゴリに応じた1つだけ。詳細は [inventory-logic.md](./inventory-logic.md) セクション5.8 参照）
- 消費ボタン（-1）

**期限表示ルール:**
- 食材カテゴリに応じて「消費期限」「賞味期限」「鮮度目安」のうち1つだけ表示
- カテゴリ不明 or 常備品: 期限非表示
- 期限切れ: 赤背景
- 期限3日以内: 黄背景
- それ以外: 通常背景

**操作:**
- アイテムタップ → 編集モーダルを開く
- 消費ボタン → 数量を1減算（楽観的更新）

### 4.3 編集モーダル（InventoryEditModal）

```
┌─────────────────────────────┐
│ 在庫を編集           [×]   │
├─────────────────────────────┤
│                             │
│ 食材名                      │
│ ┌─────────────────────┐     │
│ │ 卵                  │     │
│ └─────────────────────┘     │
│                             │
│ 数量          単位          │
│ ┌─────────┐  ┌─────┐        │
│ │ 6       │  │ 個  │        │
│ └─────────┘  └─────┘        │
│                             │
│ [消費期限] [賞味期限]  ← トグル切替│
│ ┌─────────────────────┐     │
│ │ 2025-02-10          │     │
│ └─────────────────────┘     │
│                             │
│ メモ                        │
│ ┌─────────────────────┐     │
│ │                     │     │
│ └─────────────────────┘     │
│                             │
├─────────────────────────────┤
│ [削除]              [保存]  │
└─────────────────────────────┘
```

> **期限タイプ切り替え**: トグルボタンで「消費期限 / 賞味期限（or 鮮度目安）」を切り替え可能。
> 初期値はカテゴリ自動判定または既存データから推定。
> 詳細は [inventory-logic.md](./inventory-logic.md) セクション5.8 参照。

**操作:**
- 保存ボタン → PUT APIを呼び出し、一覧を更新
- 削除ボタン → 確認ダイアログ → DELETE APIを呼び出し
- ×ボタン / 背景タップ → モーダルを閉じる

### 4.4 空状態

在庫が0件の場合:
```
┌─────────────────────────────┐
│                             │
│         📦                  │
│    在庫がありません          │
│  通知画面の「＋」から         │
│  食材を登録してください       │
│                             │
└─────────────────────────────┘
```

---

## 5. 画面遷移

```
[BottomNav]
    │
    ├── Notifications (/notifications)
    │     右下の「＋」ボタン
    │       └── アクションシート
    │             ├── 手入力で追加 → 在庫1件登録
    │             ├── レシートを読み取る → プレビュー → 在庫一括登録
    │             └── カメラで撮影 → プレビュー → 在庫一括登録
    │
    ├── 在庫 (/inventory)
    │     在庫一覧表示
    │       ├── アイテムタップ → 編集モーダル
    │       │     ├── 保存 → 一覧更新 → モーダル閉じる
    │       │     └── 削除 → 確認 → 一覧から削除 → モーダル閉じる
    │       └── 消費ボタン(-1) → 数量減算（0で自動削除）
    │
    └── レシピ (/recipes)
          レシピ閲覧・作成のみ（在庫入力導線なし）
```

---

## 6. エラーハンドリング

| 状況 | 対応 |
|------|------|
| API通信エラー | アラート表示 + コンソールログ |
| 消費時のエラー | 楽観的更新をロールバック（再取得） |
| 保存時のエラー | アラート表示 |
| 削除時のエラー | アラート表示 |

---

## 7. 認証

現在は `DEFAULT_USER_ID = 'mock-user-001'` を使用（本認証未実装）。

---

## 8. 変更履歴

| 日付 | 内容 |
|------|------|
| 2025-02-01 | 初版作成 |
| 2026-02-11 | 期限タイプ表示改善: 食材カテゴリに応じた1期限表示、トグル切替、ExpiryDateInputコンポーネント追加 |
| 2026-02-12 | 通知画面限定の在庫入力導線に変更: 「＋」→アクションシート（手入力/レシート/カメラ）とOCR失敗時フォールバックを追加 |
