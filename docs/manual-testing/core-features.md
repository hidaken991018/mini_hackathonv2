# コア機能 手動テスト手順書

作成日: 2026-02-12
目的: リリース前やリグレッション確認時に使用する、全機能の基本動作チェックリスト

## 前提条件

- [ ] 開発サーバーが起動していること (`npm run dev`)
- [ ] ブラウザで `http://localhost:3000` にアクセスできること
- [ ] テスト用アカウントでログイン済みであること

---

## 認証

### TC-AUTH-01: 未ログイン時のリダイレクト

**目的:** 未認証ユーザーが保護ページにアクセスできないことを確認

**手順:**
1. ブラウザのシークレットウィンドウを開く
2. `http://localhost:3000/inventory` にアクセスする

**期待結果:**
- ログインページ (`/auth/signin`) にリダイレクトされる

### TC-AUTH-02: ログイン・ログアウト

**目的:** 認証フローが正常に動作することを確認

**手順:**
1. `/auth/signin` にアクセスする
2. Google OAuth またはメール/パスワードでログインする
3. ログイン後、在庫ページ (`/inventory`) が表示されることを確認
4. ログアウトボタンをクリックする

**期待結果:**
- ログイン後: 在庫ページに遷移し、自分の在庫が表示される
- ログアウト後: ログインページにリダイレクトされる

**DevTools確認:**
- Networkタブ: `POST /api/auth/sync-user` が200で返ること
- Applicationタブ: Firebase認証トークンが設定されること

### TC-AUTH-03: APIの認証チェック

**目的:** API が未認証リクエストを拒否することを確認

**手順（DevTools Console）:**
```javascript
// 認証ヘッダーなしでAPIを呼び出す
fetch('/api/inventories').then(r => console.log('Status:', r.status))
```

**期待結果:**
- ステータスコード `401` が返る

---

## レシート解析

### TC-RECEIPT-01: レシート画像のアップロードと解析

**目的:** レシート画像からの食材抽出が正常に動作することを確認

**前提:** ログイン済み、テスト用レシート画像を準備

**手順:**
1. 入力タブ (`/input`) に移動する
2. カメラアイコンまたはファイル選択からレシート画像をアップロードする
3. 解析結果のプレビューが表示されるまで待つ

**期待結果:**
- 食材名、数量、単位が正しく抽出される
- 食材以外の項目（ポイントカード、袋代など）が除外されている
- プレビュー画面で各食材を確認・編集できる

**DevTools確認:**
- Networkタブ: `POST /api/analyze-receipt` が200で返ること
- レスポンスのJSONに食材リストが含まれること

### TC-RECEIPT-02: 在庫への一括登録

**目的:** 解析結果を在庫に正しく登録できることを確認

**前提:** TC-RECEIPT-01 の解析結果が表示されている状態

**手順:**
1. 解析結果のプレビュー画面で食材リストを確認する
2. 必要に応じて数量を修正する
3. 登録ボタンをクリックする
4. 在庫タブ (`/inventory`) に移動する

**期待結果:**
- 登録完了のメッセージが表示される
- 在庫一覧に登録した食材が表示される
- 数量と単位が正しいこと

**DevTools確認:**
- Networkタブ: `POST /api/inventories/bulk` が200で返ること

### TC-RECEIPT-03: レシート以外の画像

**目的:** 不正な画像に対して適切なエラーが返ることを確認

**手順:**
1. 入力タブでレシート以外の画像（風景写真など）をアップロードする

**期待結果:**
- エラーメッセージが表示される、または空の食材リストが返る
- アプリがクラッシュしないこと

---

## 在庫管理

### TC-INV-01: 在庫一覧の表示

**目的:** 自分の在庫が正しく表示されることを確認

**手順:**
1. 在庫タブ (`/inventory`) に移動する

**期待結果:**
- 自分の在庫のみが表示される（他ユーザーの在庫は表示されない）
- 食材名、数量、単位、賞味期限が正しく表示される
- 賞味期限が近い食材にアラート表示がされる

### TC-INV-02: 消費操作

**目的:** 消費ボタンで数量が正しく減少することを確認

**前提:** 数量2以上の在庫が存在すること

**手順:**
1. 在庫一覧で数量2以上の食材の消費ボタン(-1)をクリックする
2. 数量が1減少することを確認する

**期待結果:**
- 数量が即座に1減少する（楽観的UI更新）
- ページをリロードしても数量が維持される

**DevTools確認:**
- Networkタブ: `PATCH /api/inventories/{id}/consume` が200で返ること

### TC-INV-03: 数量0での自動削除

**目的:** 数量が0になった在庫が自動削除されることを確認

**前提:** 数量1の在庫が存在すること

**手順:**
1. 数量1の食材の消費ボタン(-1)をクリックする

**期待結果:**
- 該当の在庫が一覧から消える
- ページをリロードしても表示されないこと

### TC-INV-04: 在庫の編集

**目的:** 編集モーダルで在庫情報を変更できることを確認

**手順:**
1. 在庫一覧で任意の食材をタップ/クリックして編集モーダルを開く
2. 数量、賞味期限を変更する
3. 保存ボタンをクリックする

**期待結果:**
- 変更内容が反映される
- ページをリロードしても変更が維持される

### TC-INV-05: 在庫の削除

**目的:** 在庫を手動で削除できることを確認

**手順:**
1. 編集モーダルまたは削除ボタンから削除操作を行う
2. 確認ダイアログが表示される場合は「削除」を選択する

**期待結果:**
- 該当の在庫が一覧から削除される

---

## AIチャット

### TC-CHAT-01: メッセージの送受信

**目的:** AIチャットが正常に動作することを確認

**手順:**
1. チャットタブ (`/chat`) に移動する
2. 「今日の献立を教えて」と入力して送信する

**期待結果:**
- AIからの回答が表示される
- 在庫食材に基づいた回答が含まれる

### TC-CHAT-02: レシピからのチャット遷移

**目的:** レシピ画面からチャットへの初期メッセージ転送を確認

**手順:**
1. 通知タブでレシピモーダルを開く
2. レシピに関する質問ボタン（存在する場合）をクリック
3. チャットタブに遷移することを確認

**期待結果:**
- チャットタブに遷移し、レシピに関連する初期メッセージが設定されている

---

## 通知

### TC-NOTIFY-01: 通知一覧の表示

**目的:** 通知が正しく表示されることを確認

**前提:** 通知データが存在すること

**手順:**
1. 通知タブ (`/notifications`) に移動する

**期待結果:**
- 通知一覧がグリッド表示される
- 未読通知と既読通知が区別できる

### TC-NOTIFY-02: 通知の既読化

**目的:** 通知を既読にできることを確認

**手順:**
1. 未読の通知をタップ/クリックする

**期待結果:**
- 通知が既読状態になる（UI上の表示が変わる）
- 楽観的UI更新により即座に反映される

**DevTools確認:**
- Networkタブ: `PATCH /api/notifications/{id}/read` が200で返ること

### TC-NOTIFY-03: レシピモーダルの表示

**目的:** レシピ通知のモーダルが正しく表示されることを確認

**前提:** レシピ提案の通知が存在すること

**手順:**
1. レシピ提案の通知をタップする
2. レシピスライドモーダルが表示される

**期待結果:**
- レシピ名、材料、手順が表示される
- 料理画像が表示される（生成済みの場合）
- 調理確認ボタンが機能する

---

## セキュリティ（共通）

### TC-SEC-01: セキュリティヘッダーの確認

**目的:** HTTP セキュリティヘッダーが正しく設定されていることを確認

**手順:**
1. ブラウザDevToolsのNetworkタブを開く
2. 任意のページにアクセスする
3. HTMLドキュメントのレスポンスヘッダーを確認する

**期待結果:**
以下のヘッダーが含まれること:
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `X-XSS-Protection: 1; mode=block`
- `Referrer-Policy: strict-origin-when-cross-origin`
- `Permissions-Policy` が設定されていること

### TC-SEC-02: エラーレスポンスの情報漏洩チェック

**目的:** エラー時に内部情報（スタックトレース、DB構造など）が漏洩していないことを確認

**手順（DevTools Console）:**
```javascript
// 存在しないIDでリクエスト
fetch('/api/inventories/nonexistent-id', {
  headers: { 'Authorization': 'Bearer ' + await firebase.auth().currentUser.getIdToken() }
}).then(r => r.json()).then(console.log)
```

**期待結果:**
- エラーレスポンスに一般的なメッセージのみ含まれる
- スタックトレース、Prismaのエラー詳細、テーブル名などが含まれない

### TC-SEC-03: 他ユーザーデータへのアクセス制限

**目的:** IDOR（不正な直接オブジェクト参照）が防止されていることを確認

**手順（DevTools Console）:**
```javascript
// 他ユーザーの在庫IDでアクセスを試みる（IDは適宜変更）
fetch('/api/inventories/other-user-inventory-id', {
  headers: { 'Authorization': 'Bearer ' + await firebase.auth().currentUser.getIdToken() }
}).then(r => console.log('Status:', r.status))
```

**期待結果:**
- ステータスコード `403` または `404` が返る
- 他ユーザーのデータは取得できない

---

## テスト結果記録

| カテゴリ | TC | 結果 (PASS/FAIL) | 確認者 | 日時 | 備考 |
|----------|-----|-------------------|--------|------|------|
| 認証 | TC-AUTH-01 | - | - | - | - |
| 認証 | TC-AUTH-02 | - | - | - | - |
| 認証 | TC-AUTH-03 | - | - | - | - |
| レシート | TC-RECEIPT-01 | - | - | - | - |
| レシート | TC-RECEIPT-02 | - | - | - | - |
| レシート | TC-RECEIPT-03 | - | - | - | - |
| 在庫 | TC-INV-01 | - | - | - | - |
| 在庫 | TC-INV-02 | - | - | - | - |
| 在庫 | TC-INV-03 | - | - | - | - |
| 在庫 | TC-INV-04 | - | - | - | - |
| 在庫 | TC-INV-05 | - | - | - | - |
| チャット | TC-CHAT-01 | - | - | - | - |
| チャット | TC-CHAT-02 | - | - | - | - |
| 通知 | TC-NOTIFY-01 | - | - | - | - |
| 通知 | TC-NOTIFY-02 | - | - | - | - |
| 通知 | TC-NOTIFY-03 | - | - | - | - |
| セキュリティ | TC-SEC-01 | - | - | - | - |
| セキュリティ | TC-SEC-02 | - | - | - | - |
| セキュリティ | TC-SEC-03 | - | - | - | - |
